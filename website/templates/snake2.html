 <link rel="icon" sizes="16x16" href="{{ url_for('static', filename='/games/snake/img/icon.png') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='/games/snake/snake.css') }}">
<canvas id="canvas" class="hide" width="400" height="400"></canvas>
<div class="startScreen">
    <div class='IlonchaRasmi'> </div>
    <p>
        Boshlash uchun shu erni bosing<br />
        Boshqarish uchun &#8592;, &#8594;, &#8593;, &#8595; yoki (a, d, w, s) tugmalaridan foydalaning<br />
        Iloncha tanasini o'ziga yedirsangiz yutqazasiz.
    </p>
</div>
<script>
    let player = {};
    const canvas = document.getElementById('canvas');
    const startScreen = document.querySelector('.startScreen');
    let score = 0;
    let t = 1;
    var over = false;
    class SnakeGame {
        constructor() {
            this.canvas = document.getElementById('canvas');
            this.context = this.canvas.getContext('2d');
            document.addEventListener('keydown', this.onKeyPress.bind(this));
        }
        init() {
            score = 0;
            t = 1;
            this.positionX = this.positionY = 10;
            this.appleX = this.appleY = 5;
            this.tailSize = 5;
            this.trail = [];
            this.gridSize = this.tileCount = 20;
            this.velocityX = this.velocityY = 0;

            this.timer = setInterval(this.loop.bind(this), 1000 / 5);
        }
        reset() {
            clearInterval(this.timer);
            this.init();
        }
        loop() {
            this.update();
            this.draw();

        }
        update() {
            this.positionX += this.velocityX;
            this.positionY += this.velocityY;
            if (this.positionX < 0) {
                this.positionX = this.tileCount - 1;
            }
            if (this.positionY < 0) {
                this.positionY = this.tileCount - 1;
            }
            if (this.positionX > this.tileCount - 1) {
                this.positionX = 0;
            }
            if (this.positionY > this.tileCount - 1) {
                this.positionY = 0;
            }
            this.trail.forEach(t => {
                if (this.positionX === t.positionX && this.positionY === t.positionY) {
                    if (over) {
                        over = false;
                        GameOver();
                    }
                    this.reset();
                }
            });
            this.trail.push({ positionX: this.positionX, positionY: this.positionY, Score: score });
            while (this.trail.length > this.tailSize) {
                this.trail.shift();
            }
            if (this.appleX === this.positionX && this.appleY == this.positionY) {
                this.tailSize++;
                score++;
                this.appleX = Math.floor(Math.random() * this.tileCount);
                this.appleY = Math.floor(Math.random() * this.tileCount);
            }
        }
        draw() {

            this.context.fillStyle = 'black';
            this.context.fillRect(0, 0, this.canvas.width, this.canvas.height);

            this.context.fillStyle = 'white';
            this.context.font = '20px Arial';
            this.context.fillText(score, 20, 40);
            for (let i = 0; i < this.trail.length; i++) {
                this.context.fillStyle = (i == this.trail.length - 1) ? "yellow" : "white";
                this.context.fillRect(this.trail[i].positionX * this.gridSize, this.trail[i].positionY * this.gridSize, this.gridSize - 5, this.gridSize - 5);
            }
            //this.trail.forEach(t => {
            //    console.log(t);
            //    this.context.fillRect(t.positionX * this.gridSize, t.positionY * this.gridSize, this.gridSize - 5, this.gridSize - 5);
            //});
            this.context.fillStyle = 'pink';
            this.context.fillRect(this.appleX * this.gridSize, this.appleY * this.gridSize, this.gridSize - 5, this.gridSize - 5);
        }
        onKeyPress(e) {
            if ((e.keyCode === 37 || e.keyCode === 65) && this.velocityX !== 1) {
                this.velocityX = -1;
                this.velocityY = 0;
            }
            if ((e.keyCode === 38 || e.keyCode === 87) && this.velocityY !== 1) {
                this.velocityX = 0;
                this.velocityY = -1;
            }
            if ((e.keyCode === 39 || e.keyCode === 68) && this.velocityX !== -1) {
                this.velocityX = 1;
                this.velocityY = 0;
            }
            if ((e.keyCode === 40 || e.keyCode === 83) && this.velocityY !== -1) {
                this.velocityX = 0;
                this.velocityY = 1;
            }
            over = true;
        }
    }
    startScreen.addEventListener('click', start);
    let snake_game = new SnakeGame();
    function RefreshGame() {
        //snake_game = new SnakeGame();
    }
    function start() {
        player.start = true;
        canvas.classList.remove('hide');
        startScreen.classList.add('hide');
        snake_game.init();
    }
    function GameOver() {
        player.start = false;
        canvas.classList.add('hide');
        startScreen.classList.remove('hide');
        RefreshGame();
        startScreen.classList.remove('hide');
        startScreen.innerHTML = "<div class='IlonchaRasmi'></div><br /> O'yin tugadi <br /> Sizning yakuniy hisobingiz " + score +
            "<br /> O'yinni qayta boshlash uchun shu yerni bosing.";
    }
</script>